[
  2147483652,
  1,
  "",
  13751,
  "--CUSTOM_CODE\r\ndo\r\n\tlocal DamageTrigger = CreateTrigger()\r\n\tfor i = 0, bj_MAX_PLAYER_SLOTS - 1 do\r\n\t\tTriggerRegisterPlayerUnitEvent(DamageTrigger, Player(i), EVENT_PLAYER_UNIT_DAMAGING) -- До вычета брони\r\n\t\tTriggerRegisterPlayerUnitEvent(DamageTrigger, Player(i), EVENT_PLAYER_UNIT_DAMAGED) -- После вычета брони\r\n\tend\r\n\tTriggerAddAction(DamageTrigger, function()\r\n\t\tlocal damage     = GetEventDamage() -- число урона\r\n\t\tlocal damageType = BlzGetEventDamageType()\r\n\t\tif damage < 1 then return end\r\n\t\t\r\n\t\tlocal eventId        = GetHandleId(GetTriggerEventId())\r\n\t\t--local isEventDamaging = eventId == GetHandleId(EVENT_PLAYER_UNIT_DAMAGING)\r\n\t\tlocal isEventDamaged = eventId == GetHandleId(EVENT_PLAYER_UNIT_DAMAGED)\r\n\t\t\r\n\t\tlocal target         = GetTriggerUnit() -- тот кто получил урон\r\n\t\tlocal caster         = GetEventDamageSource() -- тот кто нанёс урон\r\n\t\tlocal casterOwner    = GetOwningPlayer(caster)\r\n\t\t\r\n\t\tif isEventDamaged then\r\n\t\t\tdamage         = GetEventDamage()\r\n\t\t\tlocal textSize = damage / 100000 + 0.012\r\n\t\t\tFlyTextTag('-' .. math.ceil(damage), textSize, GetUnitX(target) - 32, GetUnitY(target), 32, 255, 0, 0, 255, 0, 0.03, 1.5, 2, casterOwner)\r\n\t\tend\r\n\tend)\r\nend\r\n\r\ndo\r\n\tlocal InitGlobalsOrigin = InitGlobals\r\n\tfunction InitGlobals()\r\n\t\tInitGlobalsOrigin()\r\n\t\t\r\n\t\tdo\r\n\t\t\tlocal dummy  = CreateUnit(Player(PLAYER_NEUTRAL_PASSIVE), FourCC('dumy'), 0, 0, 0)\r\n\t\t\tlocal stunId = FourCC('stun')\r\n\t\t\tUnitAddAbility(dummy, stunId)\r\n\t\t\tlocal stunAbility = BlzGetUnitAbility(dummy, stunId)\r\n\t\t\t\r\n\t\t\t---@param target unit\r\n\t\t\t---@param durationNormal real\r\n\t\t\t---@param durationHero real\r\n\t\t\tfunction DummyCastStun(target, durationNormal, durationHero)\r\n\t\t\t\tSetUnitX(dummy, GetUnitX(target))\r\n\t\t\t\tSetUnitY(dummy, GetUnitY(target))\r\n\t\t\t\tBlzSetAbilityRealLevelField(stunAbility, ABILITY_RLF_DURATION_NORMAL, 0, durationNormal)\r\n\t\t\t\tBlzSetAbilityRealLevelField(stunAbility, ABILITY_RLF_DURATION_HERO, 0, durationHero)\r\n\t\t\t\tIssueTargetOrderById(dummy, 852095, target) -- thunderbolt\r\n\t\t\tend\r\n\t\tend\r\n\t\t\r\n\t\tdo\r\n\t\t\tlocal dummys      = {}\r\n\t\t\tlocal rootAbility = {}\r\n\t\t\tlocal rootId      = FourCC('root')\r\n\t\t\tfor i = 0, bj_MAX_PLAYER_SLOTS - 1 do\r\n\t\t\t\tdummys[i] = CreateUnit(Player(i), FourCC('dumy'), 0, 0, 0)\r\n\t\t\t\tUnitAddAbility(dummys[i], rootId)\r\n\t\t\t\trootAbility[i] = BlzGetUnitAbility(dummys[i], rootId)\r\n\t\t\tend\r\n\t\t\t\r\n\t\t\t---@param player player\r\n\t\t\t---@param target unit\r\n\t\t\t---@param durationNormal real\r\n\t\t\t---@param durationHero real\r\n\t\t\tfunction DummyCastRoot(player, target, durationNormal, durationHero, damage)\r\n\t\t\t\tlocal id      = GetPlayerId(player)\r\n\t\t\t\tlocal dummy   = dummys[id]\r\n\t\t\t\tlocal ability = rootAbility[id]\r\n\t\t\t\t\r\n\t\t\t\tSetUnitX(dummy, GetUnitX(target))\r\n\t\t\t\tSetUnitY(dummy, GetUnitY(target))\r\n\t\t\t\tBlzSetAbilityRealLevelField(ability, ABILITY_RLF_DURATION_NORMAL, 0, durationNormal)\r\n\t\t\t\tBlzSetAbilityRealLevelField(ability, ABILITY_RLF_DURATION_HERO, 0, durationHero)\r\n\t\t\t\tBlzSetAbilityRealLevelField(ability, ABILITY_RLF_DAMAGE_PER_SECOND_EER1, 0, damage)\r\n\t\t\t\tUnitShareVision(target, player, true)\r\n\t\t\t\tIssueTargetOrderById(dummy, 852171, target) -- entanglingroots\r\n\t\t\t\tUnitShareVision(target, player, false)\r\n\t\t\tend\r\n\t\tend\r\n\tend\r\nend\r\n---@param text string\r\n---@param textSize real\r\n---@param x real\r\n---@param y real\r\n---@param z real\r\n---@param red integer\r\n---@param green integer\r\n---@param blue integer\r\n---@param alpha integer\r\n---@param xvel real\r\n---@param yvel real\r\n---@param fadepoint real\r\n---@param lifespan real\r\n---@param player player\r\n---@return texttag\r\nfunction FlyTextTag(text, textSize, x, y, z, red, green, blue, alpha, xvel, yvel, fadepoint, lifespan, player)\r\n\tlocal t = CreateTextTag()\r\n\tSetTextTagText(t, text, textSize)\r\n\tSetTextTagPos(t, x, y, z)\r\n\tSetTextTagColor(t, red, green, blue, alpha)\r\n\tSetTextTagVelocity(t, xvel, yvel)\r\n\tSetTextTagFadepoint(t, fadepoint)\r\n\tSetTextTagLifespan(t, lifespan)\r\n\tSetTextTagPermanent(t, false)\r\n\tif player ~= nil then\r\n\t\tSetTextTagVisibility(t, player == GetLocalPlayer())\r\n\tend\r\n\treturn t\r\nend\r\n\r\n---@param target widget\r\n---@param text string\r\n---@param player player\r\n---@return texttag\r\nfunction FlyTextTagGoldBounty(target, text, player)\r\n\treturn FlyTextTag(text, 0.024, GetWidgetX(target) - 16, GetWidgetY(target), 0, 255, 220, 0, 255, 0, 0.03, 2, 3, player)\r\nend\r\n\r\n---@param target widget\r\n---@param text string\r\n---@param player player\r\n---@return texttag\r\nfunction FlyTextTagLumberBounty(target, text, player)\r\n\treturn FlyTextTag(text, 0.024, GetWidgetX(target) - 16, GetWidgetY(target), 0, 0, 200, 80, 255, 0, 0.03, 2, 3, player)\r\nend\r\n\r\n---@param target widget\r\n---@param text string\r\n---@param player player\r\n---@return texttag\r\nfunction FlyTextTagMiss(target, text, player)\r\n\treturn FlyTextTag(text, 0.024, GetWidgetX(target), GetWidgetY(target), 0, 255, 0, 0, 255, 0, 0.03, 1, 3, player)\r\nend\r\n\r\n---@param target widget\r\n---@param text string\r\n---@param player player\r\n---@return texttag\r\nfunction FlyTextTagCriticalStrike(target, text, player)\r\n\treturn FlyTextTag(text, 0.024, GetWidgetX(target), GetWidgetY(target), 0, 255, 0, 0, 255, 0, 0.04, 2, 5, player)\r\nend\r\n\r\n---@param target widget\r\n---@param text string\r\n---@param player player\r\n---@return texttag\r\nfunction FlyTextTagManaBurn(target, text, player)\r\n\treturn FlyTextTag(text, 0.024, GetWidgetX(target), GetWidgetY(target), 0, 82, 82, 255, 255, 0, 0.04, 2, 5, player)\r\nend\r\n\r\n---@param target widget\r\n---@param text string\r\n---@param player player\r\n---@return texttag\r\nfunction FlyTextTagShadowStrike(target, text, player)\r\n\treturn FlyTextTag(text, 0.024, GetWidgetX(target), GetWidgetY(target), 0, 160, 255, 0, 255, 0, 0.04, 2, 5, player)\r\nend\r\nfunction Heal(caster, target, heal, show)\r\n\tTimerStart(CreateTimer(), 0.00, false, function()\r\n\t\tlocal lose = GetWidgetLife(target) - GetUnitState(target, UNIT_STATE_LIFE)\r\n\t\tlocal k    = 1\r\n\t\theal       = heal * k\r\n\t\t--local over = heal > lose and heal > lose or 0 ---@type real\r\n\t\t\r\n\t\tSetWidgetLife(target, GetWidgetLife(target) + heal)\r\n\t\tif show == nil or show == true then\r\n\t\t\tlocal textSize = heal / 100000 + 0.012\r\n\t\t\tFlyTextTag('+' .. math.ceil(heal), textSize, GetUnitX(target) - 32, GetUnitY(target), 0, 30, 230, 29, 255, 0, 0.03, 1.5, 2, nil)\r\n\t\tend\r\n\tend)\r\nend\r\n---@param x real\r\n---@param distance real\r\n---@param angle real radian\r\n---@return real\r\nfunction math.offsetX(x, distance, angle)\r\n\treturn distance * math.cos(angle) + x\r\nend\r\n\r\n---@param y real\r\n---@param distance real\r\n---@param angle real radian\r\n---@return real\r\nfunction math.offsetY(y, distance, angle)\r\n\treturn distance * math.sin(angle) + y\r\nend\r\n\r\n---@param x real\r\n---@param y real\r\n---@param distance real\r\n---@param angle real radian\r\n---@return real, real\r\nfunction math.offsetXY(x, y, distance, angle)\r\n\treturn distance * math.cos(angle) + x, distance * math.sin(angle) + y\r\nend\r\n\r\n---@param zs real начальная высота одного края дуги\r\n---@param ze real конечная высота другого края дуги\r\n---@param h real максимальная высота на середине расстояния (x = d / 2)\r\n---@param d real общее расстояние до цели\r\n---@param x real расстояние от исходной цели до точки\r\n---@return real\r\nfunction math.parabolaZ(zs, ze, h, d, x)\r\n\treturn (2 * (zs + ze - 2 * h) * (x / d - 1) + ze - zs) * (x / d) + zs\r\nend\r\n\r\n---@param xa real\r\n---@param ya real\r\n---@param xb real\r\n---@param yb real\r\n---@return real\r\nfunction math.distanceXY(xa, ya, xb, yb)\r\n\tlocal dx, dy = xb - xa, yb - ya\r\n\treturn math.sqrt(dx * dx + dy * dy)\r\nend\r\n---@param xa real\r\n---@param ya real\r\n---@param za real\r\n---@param xb real\r\n---@param yb real\r\n---@param zb real\r\n---@return real\r\nfunction math.distanceXYZ(xa, ya, za, xb, yb, zb)\r\n\tlocal dx, dy, dz = xb - xa, yb - ya, zb - za\r\n\treturn math.sqrt(dx * dx + dy * dy + dz * dz)\r\nend\r\n\r\n---@param xa real\r\n---@param ya real\r\n---@param xb real\r\n---@param yb real\r\n---@return real radian\r\nfunction math.angleXY(xa, ya, xb, yb)\r\n\treturn math.atan(yb - ya, xb - xa)\r\nend\r\n\r\n---@param a real radian\r\n---@param b real radian\r\n---@return real radian\r\nfunction math.angleDiff(a, b)\r\n\tlocal c = a > b and a - b or b - a\r\n\tlocal d = a > b and b - a + 2 * math.pi or a - b + 2 * math.pi\r\n\treturn c > d and d or c\r\nend\r\n\r\n-- https://xgm.guru/p/wc3/iscoordsincircle\r\n-- Проверяет, находится ли [x,y] в окружности [cx,cy] радиусом r\r\n---@param x table\r\n---@param y table\r\n---@param cx table\r\n---@param cy table\r\n---@param r table\r\n---@return boolean\r\nfunction math.inCircleXY(x, y, cx, cy, r)\r\n\treturn (cx - x) * (cx - x) + (cy - y) * (cy - y) < r * r\r\nend\r\n\r\n-- xgm.guru/p/wc3/warden-math\r\n---@param a real degrees\r\n---@param b real degrees\r\n---@return real degrees\r\nfunction math.angleDiffDeg(a, b)\r\n\ta, b = math.abs(a), math.abs(b)\r\n\tif a > b then\r\n\t\ta, b = b, a\r\n\tend\r\n\tlocal x = b - 360\r\n\tif b - a > a - x then\r\n\t\tb = x\r\n\tend\r\n\treturn math.abs(a - b)\r\nend\r\n\r\n-- https://xgm.guru/p/wc3/perpendicular\r\n-- Находит длину перпендикуляра от линии проходящей через [xa, ya][xb, yb] к точке [xc, yc]\r\n---@param xa real\r\n---@param ya real\r\n---@param xb real\r\n---@param yb real\r\n---@param xc real\r\n---@param yc real\r\n---@return real\r\nfunction math.perpendicular(xa, ya, xb, yb, xc, yc)\r\n\treturn math.sqrt((xa - xc) * (xa - xc) + (ya - yc) * (ya - yc)) * math.sin(math.atan(yc - ya, xc - xa) - math.atan(yb - ya, xb - xa))\r\nend\r\ndo\r\n\tlocal RANGE             = 10 -- Расстояние, на котором проходит проверка\r\n\tlocal DUMMY             = FourCC('wolg') -- Ид предмета для проверки проходимости\r\n\t\r\n\tlocal rect---@type rect\r\n\tlocal item ---@type item\r\n\t\r\n\tlocal InitGlobalsOrigin = InitGlobals\r\n\tfunction InitGlobals()\r\n\t\tInitGlobalsOrigin()\r\n\t\trect = Rect(0, 0, 128, 128)\r\n\t\titem = CreateItem(DUMMY, 0, 0)\r\n\t\tSetItemVisible(item, false)\r\n\tend\r\n\t\r\n\tlocal items = {}\r\n\tlocal function hide()\r\n\t\tlocal target = GetEnumItem()\r\n\t\tif not IsItemVisible(target) then return end\r\n\t\ttable.insert(items, target)\r\n\t\tSetItemVisible(target, false)\r\n\tend\r\n\t\r\n\t---@param x real\r\n\t---@param y real\r\n\t---@return boolean\r\n\tfunction IsTerrainWalkable(x, y)\r\n\t\tMoveRectTo(rect, x, y)\r\n\t\tEnumItemsInRect(rect, nil, hide)\r\n\t\t\r\n\t\tSetItemPosition(item, x, y)\r\n\t\tlocal dx = GetItemX(item) - x\r\n\t\tlocal dy = GetItemY(item) - y\r\n\t\tSetItemVisible(item, false)\r\n\t\t\r\n\t\tfor i = 1, #items do\r\n\t\t\tSetItemVisible(items[i], true)\r\n\t\tend\r\n\t\titems = {}\r\n\t\t\r\n\t\treturn dx * dx + dy * dy <= RANGE * RANGE and not IsTerrainPathable(x, y, PATHING_TYPE_WALKABILITY)\r\n\tend\r\nend\r\n---@param x real\r\n---@param y real\r\n---@return boolean\r\nfunction IsTerrainDeepWater (x, y)\r\n\treturn not IsTerrainPathable(x, y, PATHING_TYPE_FLOATABILITY) and IsTerrainPathable(x, y, PATHING_TYPE_WALKABILITY)\r\nend\r\n---@param x real\r\n---@param y real\r\n---@return boolean\r\nfunction IsTerrainShallowWater (x, y)\r\n\treturn not IsTerrainPathable(x, y, PATHING_TYPE_FLOATABILITY) and not IsTerrainPathable(x, y, PATHING_TYPE_WALKABILITY) and IsTerrainPathable(x, y, PATHING_TYPE_BUILDABILITY)\r\nend\r\n---@param x real\r\n---@param y real\r\n---@return boolean\r\nfunction IsTerrainLand(x, y)\r\n\treturn IsTerrainPathable(x, y, PATHING_TYPE_FLOATABILITY)\r\nend\r\n---@param x real\r\n---@param y real\r\n---@return boolean\r\nfunction IsTerrainPlatform (x, y)\r\n\treturn not IsTerrainPathable(x, y, PATHING_TYPE_FLOATABILITY) and not IsTerrainPathable(x, y, PATHING_TYPE_WALKABILITY) and not IsTerrainPathable(x, y, PATHING_TYPE_BUILDABILITY)\r\nend\r\ndo\r\n\tlocal syncInterval                       = 0.25\r\n\tPLAYER_CAM_TARGET_X, PLAYER_CAM_TARGET_Y = {}, {}\r\n\t\r\n\t---@param player player\r\n\t---@return real,real\r\n\tfunction GetPlayerCameraTargetXY(player)\r\n\t\tlocal playerId = GetPlayerId(player)\r\n\t\treturn PLAYER_CAM_TARGET_X[playerId] or 0, PLAYER_CAM_TARGET_Y[playerId] or 0\r\n\tend\r\n\t\r\n\tlocal prefixX, prefixY = 'SyncCameraTargetX', 'SyncCameraTargetY'\r\n\tTimerStart(CreateTimer(), syncInterval, true, function()\r\n\t\tfor i = 0, bj_MAX_PLAYER_SLOTS - 1 do\r\n\t\t\tlocal player = Player(i)\r\n\t\t\tif GetPlayerController(player) == MAP_CONTROL_USER and GetPlayerSlotState(player) == PLAYER_SLOT_STATE_PLAYING then\r\n\t\t\t\tBlzSendSyncData(prefixX, GetCameraTargetPositionX())\r\n\t\t\t\tBlzSendSyncData(prefixY, GetCameraTargetPositionY())\r\n\t\t\tend\r\n\t\tend\r\n\tend)\r\n\tlocal cameraSyncTrigger = CreateTrigger()\r\n\tTriggerAddAction(cameraSyncTrigger, function()\r\n\t\tlocal data                            = BlzGetTriggerSyncPrefix() == prefixX and PLAYER_CAM_TARGET_X or PLAYER_CAM_TARGET_Y ---@type table\r\n\t\tdata[GetPlayerId(GetTriggerPlayer())] = tonumber(BlzGetTriggerSyncData())\r\n\tend)\r\nend\r\n\r\ndo\r\n\tlocal sync              = {\r\n\t\t'GetCameraBoundMaxX'\r\n\t}\r\n\t\r\n\tlocal InitGlobalsOrigin = InitGlobals ---@type function\r\n\tfunction InitGlobals()\r\n\t\tInitGlobalsOrigin()\r\n\t\t--print(123)\r\n\t\t\r\n\t\t--print(_G['GetCameraBoundMaxX'])\r\n\tend\r\nend\r\ndo\r\n\tlocal InitGlobalsOrigin = InitGlobals\r\n\tfunction InitGlobals()\r\n\t\tInitGlobalsOrigin()\r\n\t\tFogEnable(false)\r\n\t\tFogMaskEnable(false)\r\n\t\t\r\n\t\tfor i = 0, bj_MAX_PLAYER_SLOTS - 1 do\r\n\t\t\tlocal player = Player(i)\r\n\t\t\tif GetPlayerController(player) == MAP_CONTROL_USER and GetPlayerSlotState(player) == PLAYER_SLOT_STATE_PLAYING then\r\n\t\t\t\tlocal x, y = 0, 0\r\n\t\t\t\tlocal hero = CreateUnit(player, FourCC('hfoo'), x, y, 0)\r\n\t\t\t\tif player == GetLocalPlayer() then\r\n\t\t\t\t\tSelectUnit(hero, true)\r\n\t\t\t\t\tPanCameraToTimed(x, y, 0)\r\n\t\t\t\tend\r\n\t\t\tend\r\n\t\tend\r\n\t\t\r\n\t\tprint 'Press ESC to test'\r\n\t\tlocal escTrigger = CreateTrigger()\r\n\t\tTriggerRegisterPlayerEventEndCinematic(escTrigger, Player(0))\r\n\t\tTriggerAddAction(escTrigger, function()\r\n\t\t\t\r\n\t\t\tprint 'work'\r\n\t\tend)\r\n\t\r\n\t\r\n\tend\r\nend\r\n--CUSTOM_CODE",
  0
]